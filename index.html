<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Part III Course-O-Meter (Hierarchical)</title>

<script type="text/javascript">
// Final, hierarchical course data with robust schedule handling
var courses = [
    // Michaelmas
    {"c": "Cosmology", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR2"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Category Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR4"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Probabilistic Combinatorics", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR13"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Symmetries, Fields and Particles", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR2"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Algebraic Geometry", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR5"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Structure and Evolution of Stars", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR11"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Biological Physics", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR12"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Soft Matter and Biological Physics"},
    {"c": "Gaussian Processes and Measures", "notes": "First lecture on Friday 10 October", "schedule": [{"type": "regular", "days": "MW", "time": 10, "room": "MR13"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Quantum Field Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR2"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Analytic Number Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR5"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Information Theory", "schedule": [{"type": "regular", "days": "MW", "time": 11, "room": "MR9"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Planetary System Dynamics", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR11"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Fluid Dynamics of Climate", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR12"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Introduction to Nonlinear Analysis", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR14"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Modern Statistical Methods", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR5"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Commutative Algebra", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR9"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Formation of Galaxies", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR11"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Non-Newtonian Fluid Mechanics", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR12"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Random Discrete Structures", "schedule": [{"type": "regular", "days": "MW", "time": 12, "room": "MR13"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Advanced Probability", "schedule": [{"type": "regular", "days": "TuThS", "time": 9, "room": "MR3"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Quantum Information Theory", "schedule": [{"type": "regular", "days": "TuTh", "time": 9, "room": "MR5"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Algebraic Topology", "schedule": [{"type": "regular", "days": "TuThS", "time": 9, "room": "MR9"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Statistical Field Theory", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR2"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Topics in Statistical Theory", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR4"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Lie Algebras and Their Representations", "schedule": [{"type": "regular", "days": "TuThS", "time": 10, "room": "MR5"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Forcing and the Continuum Hypothesis", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR11"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Perturbation Methods", "lecturer": "Dr L. Ayton", "notes": "No lecture on Wed 26 November.", "schedule": [{"type": "regular", "days": "Tu", "time": 9, "room": "MR12"}, {"type": "regular", "days": "W", "time": 13.5, "room": "MR9"}, {"type": "additional", "date": "2025-10-30", "time": 9, "room": "MR12", "notes": "Additional lecture on Thu 30 October at 9am in MR12"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Mixing Times of Markov Chains", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR13"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Differential Geometry", "schedule": [{"type": "regular", "days": "TuThS", "time": 11, "room": "MR3"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Algebraic Methods in Combinatorics", "schedule": [{"type": "regular", "days": "TuTh", "time": 11, "room": "MR5"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Analysis of Partial Differential Equations", "notes": "First lecture on Wednesday 15 October", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR5"}, {"type": "additional", "date": "2025-10-23", "time": 13.5, "room": "MR4", "notes": "Additional lecture on 23 October, 1:30pm in MR4"}, {"type": "additional", "date": "2025-11-04", "time": 13.5, "room": "MR5", "notes": "Additional lecture on 4 November, 1:30pm in MR5"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Astrophysical Fluid Dynamics", "schedule": [{"type": "regular", "days": "TuThS", "time": 11, "room": "MR12"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Quantum Information, Foundations and Gravity", "schedule": [{"type": "regular", "days": "TuTh", "time": 11, "room": "MR13"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "General Relativity", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR2"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Functional Analysis", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR4"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Local Fields", "schedule": [{"type": "regular", "days": "TuTh", "time": 12, "room": "MR5"}], "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Statistics in Medicine (Medical Practice)", "schedule": [{"type": "regular", "days": "TuTh", "time": 12, "room": "MR11"}], "T": "M", "h": 12, "u": 1.5, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics", "sync_id": "sim"},
    {"c": "Mathematical Analysis of the Incompressible Navier-Stokes Equations", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR12"}], "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},

    // Lent
    {"c": "Stochastic Calculus with Applications to Finance", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR3"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Supersymmetry", "schedule": [{"type": "regular", "days": "MF", "time": 9, "room": "MR5"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Complex Manifolds", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR9"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Fluid Dynamics of the Solid Earth", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR12"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Spectral Computations in Infinite Dimensions", "schedule": [{"type": "regular", "days": "MW", "time": 9, "room": "MR13"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},
    {"c": "Black Holes", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR2"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Logic and Computability", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR5"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Knots and Knot Concordances", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR9"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Quantum Entanglement in Many-body Physics", "schedule": [{"type": "regular", "days": "MW", "time": 10, "room": "MR11"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Slow Viscous Flow", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR12"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Diophantine Analysis", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR13"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Non-Commutative Noetherian Rings", "schedule": [{"type": "regular", "days": "MWF", "time": 10, "room": "MR14"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Elliptic Curves", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR3"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Field Theory in Cosmology", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR4"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Astrostatistics", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR9"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Noisy Mechanics", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR12"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Soft Matter and Biological Physics"},
    {"c": "Advanced Quantum Field Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR2"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Statistical Learning in Practice", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR5"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Extrasolar Planets: Atmospheres and Interiors", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR12"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Elliptic Partial Differential Equations", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR13"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Geometric Group Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 12, "room": "MR14"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "String Theory", "schedule": [{"type": "regular", "days": "TuThS", "time": 9, "room": "MR2"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Ramsey Theory", "schedule": [{"type": "regular", "days": "TuTh", "time": 9, "room": "MR3"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Biological Flows", "schedule": [{"type": "regular", "days": "TuTh", "time": 9, "room": "MR4"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Toric Geometry", "schedule": [{"type": "regular", "days": "TuThS", "time": 10, "room": "MR4"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Topological Quantum Matter", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR5"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Concentration Inequalities", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR9"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Statistics in Medicine (Survival Data)", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR11"}], "T": "L", "h": 12, "u": 1.5, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics", "sync_id": "sim"},
    {"c": "Astrophysical Black Holes", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR14"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Distribution Theory and Applications", "schedule": [{"type": "regular", "days": "TuTh", "time": 11, "room": "MR4"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},
    {"c": "Solitons, Instantons and Geometry", "schedule": [{"type": "regular", "days": "TuTh", "time": 11, "room": "MR5"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Random Walks and Phase Transitions", "schedule": [{"type": "regular", "days": "TuThS", "time": 11, "room": "MR9"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Model Theory", "schedule": [{"type": "regular", "days": "TuS", "time": 11, "room": "MR13"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Dynamics of Astrophysical Discs", "schedule": [{"type": "regular", "days": "TuTh", "time": 11, "room": "MR14"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "The Standard Model", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR2"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Analysis of Boolean Functions", "schedule": [{"type": "regular", "days": "TuTh", "time": 12, "room": "MR5"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Coxeter Groups", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR12"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Riemannian Geometry", "schedule": [{"type": "regular", "days": "TuThS", "time": 12, "room": "MR13"}], "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Robust Statistics", "schedule": [{"type": "regular", "days": "TuTh", "time": 12, "room": "MR14"}], "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Laboratory Demonstrations", "schedule": [{"type": "regular", "days": "W", "time": 14, "room": "Fluids Lab"}], "T": "L", "h": 8, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},

    // Easter
    {"c": "Gauge/Gravity Duality", "schedule": [{"type": "regular", "days": "MTuThF", "time": 10, "room": "MR3"}], "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Applications of Quantum Field Theory", "schedule": [{"type": "regular", "days": "MTuThF", "time": 11, "room": "MR3"}], "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Gravitational Waves and Numerical Relativity", "schedule": [{"type": "regular", "days": "MTuThF", "time": 12, "room": "MR3"}], "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    
    // Non-examinable Courses
    {"c": "Introduction to Modular Representation Theory", "schedule": [{"type": "regular", "days": "MW", "time": 9, "room": "MR14"}], "T": "M", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Additive Prime Number Theory", "schedule": [{"type": "regular", "days": "MW", "time": 12, "room": "MR14"}], "T": "M", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Topics in Infinite Groups", "schedule": [{"type": "regular", "days": "WF", "time": 11, "room": "MR13"}], "T": "L", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Homological Algebra", "schedule": [{"type": "regular", "days": "MWF", "time": 9, "room": "MR11"}], "T": "L", "h": 24, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Symplectic Topology", "schedule": [{"type": "regular", "days": "TuThS", "time": 9, "room": "MR12"}], "T": "L", "h": 24, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Canonical Gravity", "schedule": [{"type": "regular", "days": "TuTh", "time": 10, "room": "MR13"}], "T": "L", "h": 16, "u": 0, "e": false, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Lanfordâ€™s Theorem on Large Classical Systems", "schedule": [{"type": "regular", "days": "F", "time": 11, "room": "MR14"}], "T": "L", "h": 8, "u": 0, "e": false, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Random Surfaces and Probability in Hyperbolic Geometry", "schedule": [{"type": "regular", "days": "MW", "time": 11, "room": "MR11"}], "T": "L", "h": 16, "u": 0, "e": false, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Further Stellar Evolution", "schedule": [{"type": "regular", "days": "TuTh", "time": 12, "room": "MR11"}], "T": "L", "h": 16, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Radiative Processes in Astrophysical Plasma", "schedule": [{"type": "regular", "days": "TuTh", "time": 9, "room": "MR13"}], "T": "L", "h": 16, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Spectral Graph Theory", "schedule": [{"type": "regular", "days": "MWF", "time": 11, "room": "MR4"}], "T": "E", "h": 24, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"}
];


let isSyncing = false;

function initOmeter() {
  decodeSelectionFromURL();
  change();
  showView('list');
}

function updateShareLink() {
    let selectedIndices = [];
    for (let i = 0; i < courses.length; i++) {
        const cb = document.getElementById('cb' + i);
        if (cb && cb.checked) {
            selectedIndices.push(i);
        }
    }
    const code = selectedIndices.join(',');
    const essayState = document.getElementById('cbEssay').checked ? '1' : '0';
    
    const params = new URLSearchParams();
    if (code) params.set('s', code);
    if (essayState === '1') params.set('e', essayState);

    const paramString = params.toString();
    const hash = paramString ? '#' + paramString : '';
    shareLink.href = window.location.href.split('#')[0] + hash;
}

function decodeSelectionFromURL() {
    if (!window.location.hash || window.location.hash.length < 2) return;
    try {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const code = params.get('s');
        const essayState = params.get('e');

        if (essayState === '1') {
            const cbEssay = document.getElementById('cbEssay');
            if (cbEssay) cbEssay.checked = true;
        }

        if (code) {
            code.split(',').forEach(indexStr => {
                const i = parseInt(indexStr, 10);
                if (!isNaN(i)) {
                    const cb = document.getElementById('cb' + i);
                    if (cb) cb.checked = true;
                }
            });
        }
    } catch (e) {
        console.error("Failed to decode URL hash:", e);
    }
}

function parseDays(dayString) {
    if (!dayString) return [];
    let result = dayString.replace(/\./g, '');
    result = result.replace(/Tu/g, 'Tu,').replace(/Th/g, 'Th,');
    result = result.replace(/M/g, 'M,').replace(/W/g, 'W,').replace(/F/g, 'F,').replace(/S/g, 'S,');
    return result.split(',').filter(d => d.trim().length > 0).map(d => d.trim());
}

function change(event, changedCourseId) {
    if (isSyncing) return;

    if (changedCourseId !== undefined) {
        const changedCourse = courses[changedCourseId];
        if (changedCourse && changedCourse.sync_id) {
            isSyncing = true;
            const checkboxState = document.getElementById('cb' + changedCourseId).checked;
            courses.forEach((course, i) => {
                if (course.sync_id === changedCourse.sync_id && i !== changedCourseId) {
                    document.getElementById('cb' + i).checked = checkboxState;
                }
            });
            isSyncing = false;
        }
    }
    
    let mUnits = 0, lUnits = 0, eUnits = 0;
    
    let selectedCourses = [];
    courses.forEach((course, i) => {
      const cb = document.getElementById('cb' + i);
      if (cb && cb.checked) {
        if (course.T === 'M') mUnits += course.u;
        if (course.T === 'L') lUnits += course.u;
        if (course.T === 'E') eUnits += course.u;
        selectedCourses.push({ ...course, id: i });
      }
    });

    const timetables = { M: {}, L: {}, E: {} };
    const dateClashMap = { M: {}, L: {}, E: {} };

    selectedCourses.forEach(course => {
        if (course.schedule && timetables[course.T]) {
            course.schedule.forEach(slot => {
                if (slot.type === 'regular' && slot.days) {
                    parseDays(slot.days).forEach(day => {
                        const key = `${day}-${slot.time}`;
                        if (!timetables[course.T][key]) timetables[course.T][key] = [];
                        timetables[course.T][key].push(course.id);
                    });
                } else if (slot.type === 'additional' && slot.date) {
                    const key = `${slot.date}-${slot.time}`;
                    if (!dateClashMap[course.T][key]) dateClashMap[course.T][key] = [];
                    dateClashMap[course.T][key].push(course.id);
                }
            });
        }
    });

    const clashingCourseIds = new Set();
    [timetables, dateClashMap].forEach(clashSource => {
        for (const term in clashSource) {
            for (const slot in clashSource[term]) {
                if (clashSource[term][slot].length > 1) {
                    clashSource[term][slot].forEach(id => clashingCourseIds.add(id));
                }
            }
        }
    });

    courses.forEach((course, i) => {
        const row = document.getElementById('r' + i);
        if (!row) return;
        const cells = row.querySelectorAll('td');
        let color = '';
        if (clashingCourseIds.has(i)) {
            color = '#ffcccc';
        } else if (document.getElementById('cb' + i).checked) {
            color = '#ffffd0';
        }
        cells.forEach(cell => cell.style.backgroundColor = color);
    });

    const essayCb = document.getElementById('cbEssay');
    let essayUnits = 0;
    if (essayCb && essayCb.checked) {
      essayUnits = 3;
      lUnits += essayUnits;
    }

    const paperUnits = mUnits + lUnits + eUnits - essayUnits;
    const totalUnits = mUnits + lUnits + eUnits;

    document.getElementById('Mtotal').innerHTML = `Michaelmas Total: <strong>${mUnits}</strong> units`;
    document.getElementById('Ltotal').innerHTML = `Lent Total: <strong>${lUnits}</strong> units`;
    document.getElementById('Etotal').innerHTML = `Easter Total: <strong>${eUnits}</strong> units`;

    let warnings = [];
    if (paperUnits > 16) warnings.push(`<span style="color:red; font-weight:bold;">Warning: Exceeds 16-unit limit for lecture courses.</span>`);
    if (totalUnits > 19) warnings.push(`<span style="color:red; font-weight:bold;">Warning: Exceeds 19-unit total limit.</span>`);
    if (clashingCourseIds.size > 0) warnings.push(`<span style="color:red; font-weight:bold;">Timetable clash detected!</span>`);
    if (essayCb && essayCb.checked && totalUnits < 12) warnings.push(`Note: Below 12 units recommended for a Pass with an essay.`);

    document.getElementById('total0').innerHTML = `Total: <strong>${totalUnits}</strong> units. ${warnings.join(' ')}`;
    updateShareLink();
    generateTimetableView(selectedCourses);
}

function formatSchedule(course) {
    if (!course.schedule || course.schedule.length === 0) return '';
    
    let scheduleStr = course.schedule.filter(s => s.type === 'regular')
        .map(s => `${s.days} ${s.time}`.replace('.5', ':30')).join(', ');

    if (course.notes || course.schedule.some(s => s.type !== 'regular')) {
        scheduleStr += ' *';
    }
    return scheduleStr;
}

function generateTimetableView(selectedCourses) {
    const container = document.getElementById('timetable-view');
    container.innerHTML = '<h2>Weekly Timetable View</h2>'; 

    const terms = { M: 'Michaelmas', L: 'Lent', E: 'Easter' };
    const daysOfWeek = { M: 'Monday', Tu: 'Tuesday', W: 'Wednesday', Th: 'Thursday', F: 'Friday', S: 'Saturday' };
    const dayKeys = ['M', 'Tu', 'W', 'Th', 'F', 'S'];
    const times = [9, 10, 11, 12, 13.5, 14]; 

    let termData = { M: {}, L: {}, E: {} };
    let termNotes = { M: [], L: [], E: [] };

    selectedCourses.forEach(course => {
        if (course.notes && termNotes[course.T]) {
            termNotes[course.T].push(`<b>${course.c}:</b> ${course.notes}`);
        }
        if (course.schedule && termData[course.T]) {
            course.schedule.forEach(slot => {
                if (slot.type === 'regular') {
                    parseDays(slot.days).forEach(day => {
                        const key = `${day}-${slot.time}`;
                        if (!termData[course.T][key]) termData[course.T][key] = [];
                        termData[course.T][key].push(course);
                    });
                } else if (slot.notes) {
                    termNotes[course.T].push(`<b>${course.c}:</b> ${slot.notes}`);
                }
            });
        }
    });

    for (const termKey in terms) {
        let tableHtml = `<h3>${terms[termKey]} Term</h3>`;
        tableHtml += `<table class="timetable-grid"><thead><tr><th>Time</th>`;
        dayKeys.forEach(day => tableHtml += `<th>${daysOfWeek[day]}</th>`);
        tableHtml += `</tr></thead><tbody>`;
        
        times.forEach(time => {
            const timeLabel = (time === 13.5) ? "1:30 PM" : (time >= 12 ? `${time-12==0?12:time-12}:00 PM` : `${time}:00 AM`);
            tableHtml += `<tr><th>${timeLabel}</th>`;
            dayKeys.forEach(day => {
                const slotKey = `${day}-${time}`;
                const coursesInSlot = termData[termKey][slotKey] || [];
                let cellContent = coursesInSlot.map(c => 
                    `<div class="tt-entry">${c.c}<br><span class="tt-entry-room">(${c.schedule.find(s => s.days.includes(day) && s.time === time)?.room || 'N/A'})</span></div>`
                ).join('');
                let cellClass = coursesInSlot.length > 1 ? 'clash' : (coursesInSlot.length === 1 ? 'filled' : '');
                tableHtml += `<td class="${cellClass}">${cellContent}</td>`;
            });
            tableHtml += `</tr>`;
        });
        tableHtml += `</tbody></table>`;
        
        if (termNotes[termKey].length > 0) {
            tableHtml += `<div class="notes-section"><h4>Irregular Dates & Notes</h4><ul>`;
            termNotes[termKey].sort().forEach(note => {
                tableHtml += `<li>${note}</li>`;
            });
            tableHtml += `</ul></div>`;
        }

        container.innerHTML += tableHtml;
    }
}


function showView(viewName) {
    document.getElementById('list-view').style.display = (viewName === 'list') ? 'block' : 'none';
    document.getElementById('timetable-view').style.display = (viewName === 'timetable') ? 'block' : 'none';
    document.getElementById('list-view-btn').style.fontWeight = (viewName === 'list') ? 'bold' : 'normal';
    document.getElementById('timetable-view-btn').style.fontWeight = (viewName === 'timetable') ? 'bold' : 'normal';
}

function resetAll() {
    window.location.href = window.location.href.split('#')[0];
}

function copyShareLink(event) {
    event.preventDefault();
    const shareLink = document.getElementById('shareLink');
    const urlToCopy = shareLink.href;

    const textArea = document.createElement("textarea");
    textArea.value = urlToCopy;
    textArea.style.position = 'fixed';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        shareLink.textContent = 'URL Copied!';
        setTimeout(() => { shareLink.textContent = 'Share Selection'; }, 2000);
    } catch (err) {
        shareLink.textContent = 'Copy Failed';
         setTimeout(() => { shareLink.textContent = 'Share Selection'; }, 2000);
    }
    document.body.removeChild(textArea);
}

function expandAll() {
  const details = document.getElementsByTagName('details');
  for (let i = 0; i < details.length; i++) details[i].open = true;
}

function collapseAll() {
  const details = document.getElementsByTagName('details');
  for (let i = 0; i < details.length; i++) details[i].open = false;
}
</script>

<style type="text/css">
  body { font-family: sans-serif; }
  table { width: 100%; border-collapse: collapse; }
  td, th { border: solid black; border-width: 1px 3px 1px 3px; text-align: center; padding: 2px; }
  tr.none td { border-width: 3px 0px 3px 0px; }
  tr.box td { border: solid black; border-width: 3px 3px 3px 3px; }
  .term-container { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 20px; }
  
  details { margin-bottom: 5px; }
  summary {
    font-size: 1em; cursor: pointer; padding: 4px; margin-top: 8px; list-style: none; 
  }
  summary::-webkit-details-marker { display: none; }
  summary:before { content: '[+] '; font-family: monospace; font-size: 0.9em; }
  details[open] > summary:before { content: '[-] '; }
  
  details.main-category > summary {
    font-weight: bold; background-color: #f2f2f2; border: 1px solid #ccc; border-radius: 4px; padding: 8px;
  }
  details.main-category > details { margin-left: 20px; }
  details.sub-category > summary { font-weight: bold; }
  details.sub-category > table { margin-left: 15px; border: none; }
  details.sub-category > table td { border-width: 0 0 1px 0; border-style: dashed; border-color: #eee; }

  .timetable-grid { border-collapse: collapse; width: 100%; margin-bottom: 20px; table-layout: fixed; }
  .timetable-grid th, .timetable-grid td { 
      border: 1px solid black; 
      padding: 2px; 
      vertical-align: top; 
      height: 55px; 
      text-align: center;
  }
  .timetable-grid th { 
      background-color: yellow;
      font-size: 90%; 
      font-weight: bold;
  }
  .timetable-grid td { 
      font-size: 80%;
      padding-top: 3px;
  }
  .timetable-grid td.filled { background-color: #ffffd0; }
  .timetable-grid td.clash { background-color: #ffcccc; font-weight: bold; }
  .tt-entry { 
      font-weight: bold;
      margin-bottom: 4px;
  }
  .tt-entry-room {
      font-weight: normal;
  }
  .notes-section {
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    margin-top: 15px;
    background-color: #f9f9f9;
  }
  .notes-section h4 {
    margin-top: 0;
  }
  .notes-section ul {
    padding-left: 20px;
    margin: 0;
    text-align: left;
  }
  .notes-section li {
    margin-bottom: 5px;
  }

</style>
</head>

<body>

<h1>Part III Course-O-Meter</h1>

<p>
  <table style="width: 60em;">
    <tr class="box">
      <td width="25%"><a id="list-view-btn" href="#" onclick="showView('list'); return false;">List View</a></td>
      <td width="25%"><a id="timetable-view-btn" href="#" onclick="showView('timetable'); return false;">Timetable</a></td>
      <td width="25%"><a id="shareLink" href="#" onclick="copyShareLink(event)">Share Selection</a></td>
      <td width="25%"><a href="javascript:resetAll();">Reset</a></td>
    </tr>
  </table>
</p>

<div id="list-view" style="width: 60em;">
    <p><a href="javascript:expandAll();">Expand All</a> / <a href="javascript:collapseAll();">Collapse All</a></p>
    <script type="text/javascript">
    function generateTermHtml(term, termName) {
        let html = `<div class="term-container">`;
        html += `<div class='box' style='font-weight:bold; background-color:yellow;'><table><tr><td style='text-align:left;'>${termName}</td></tr></table></div>`;

        const termCourses = courses.map((c, i) => ({...c, id: i})).filter(c => c.T === term);
        const mainCats = [...new Set(termCourses.map(c => c.cat))].sort();

        mainCats.forEach(mainCat => {
            html += `<details class="main-category" open><summary>${mainCat}</summary>`; 
            const mainCatCourses = termCourses.filter(c => c.cat === mainCat);
            const subCats = [...new Set(mainCatCourses.map(c => c.subcat))].sort();

            subCats.forEach(subCat => {
                html += `<details class="sub-category" open><summary>${subCat}</summary><table>`; 
                html += '<col width="3%"><col width="60%"><col width="15%"><col width="10%"><col width="6%"><col width="6%">';
                html += "<tr style='font-weight:bold; font-size:90%;'><td></td><td style='text-align:left;'>Course</td><td>Time</td><td>Room</td><td>Hrs</td><td>Units</td></tr>";
                
                const subCatCourses = mainCatCourses.filter(c => c.subcat === subCat).sort((a,b) => a.c.localeCompare(b.c));
                subCatCourses.forEach(course => {
                    html += `<tr id="r${course.id}">`;
                    html += `<td><input type="checkbox" onchange="change(event, ${course.id});" id="cb${course.id}"></td>`;
                    html += `<td style="text-align:left">${course.c} ${!course.e ? '<span style="color:grey; font-size:90%;">(Non-examinable)</span>' : ''}</td>`;
                    html += `<td style="font-size:85%">${formatSchedule(course)}</td>`;
                    html += `<td style="font-size:85%">${course.schedule && course.schedule[0] ? course.schedule.map(s=>s.room).join('/') : ''}</td>`;
                    html += `<td style="font-size:90%">${course.h}</td>`;
                    html += `<td style="font-size:90%">${course.u}</td>`;
                    html += `</tr>`;
                });
                html += '</table></details>';
            });
            html += '</details>';
        });

        html += `<div class="box"><table style="border-width:0;"><tr style="font-weight:bold; background-color:yellow;">`;
        html += `<td style="border:none; text-align:left;" id="${term}total">${termName} Total: <strong>0</strong> units</td>`;
        html += `</tr></table></div></div>`;
        return html;
    }
    
    document.write(generateTermHtml('M', 'Michaelmas'));
    document.write(generateTermHtml('L', 'Lent'));
    document.write(generateTermHtml('E', 'Easter'));
    </script>

    <p>
    <table style="width: 100%;">
      <tr class="box">
        <td width="3%"><input type="checkbox" onchange="change();" id="cbEssay"></td>
        <td style="text-align:left">Part III Essay</td>
        <td style="font-size:95%; width:20%;">3 units</td>
      </tr>
      <tr class="none"><td colspan="3">&nbsp;</td></tr>
      <tr class="box">
        <td colspan="3" id="total0" style="font-weight:bold;">Total: 0 units</td>
      </tr>
    </table>
    </p>
</div>

<div id="timetable-view" style="width: 60em; display: none;">
</div>

<hr>
<i style="font-size:90%;">This tool is for guidance only, based on the Part III lecture list for the 2025-26 academic year.</i>

<script type="text/javascript">
  initOmeter();
</script>

</body>
</html>
