<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Part III Course-O-Meter (Hierarchical)</title>

<script type="text/javascript">
// Final, hierarchical course data
var courses = [
    {"c": "Commutative Algebra", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Introduction to Modular Representation Theory", "T": "M", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Lie Algebras and their Representations", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Coxeter Groups", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Noncommutative Noetherian Rings", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Topics in Infinite Groups", "T": "L", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebra"},
    {"c": "Algebraic Geometry", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Complex Manifolds", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Homological Algebra", "T": "L", "h": 24, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Toric Geometry", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Algebraic Geometry"},
    {"c": "Analysis of Partial Differential Equations", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Functional Analysis", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Introduction to Nonlinear Analysis", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Elliptic Partial Differential Equations", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Analysis and PDEs"},
    {"c": "Algebraic Methods in Combinatorics", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Probabilistic Combinatorics", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Analysis of Boolean Functions", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Ramsey Theory", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Combinatorics"},
    {"c": "Algebraic Topology", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Differential Geometry", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Geometric Group Theory", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Knots and Knot Concordances", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Riemannian Geometry", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Symplectic Topology", "T": "L", "h": 24, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Differential Geometry and Topology"},
    {"c": "Category Theory", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Forcing and the Continuum Hypothesis", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Logic and Computability", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Model Theory", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Foundations"},
    {"c": "Additive Prime Number Theory", "T": "M", "h": 16, "u": 0, "e": false, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Analytic Number Theory", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Local Fields", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Diophantine Analysis", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Elliptic Curves", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Pure Mathematics (DPMMS)", "subcat": "Number Theory"},
    {"c": "Information Theory", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Concentration Inequalities", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Stochastic Calculus with Applications to Finance", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Information and Finance"},
    {"c": "Advanced Probability", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Mixing Times of Markov Chains", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Random Discrete Structures", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Lanfordâ€™s Theorem on Large Classical Systems", "T": "L", "h": 8, "u": 0, "e": false, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Random Surfaces and Probability in Hyperbolic Geometry", "T": "L", "h": 16, "u": 0, "e": false, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Random Walks and Phase Transitions", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Probability"},
    {"c": "Gaussian Processes", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Modern Statistical Methods", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Topics in Statistical Theory", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Statistics in Medicine", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Robust Statistics", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Statistical Learning in Practise", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Statistical Laboratory (DPMMS)", "subcat": "Statistics"},
    {"c": "Quantum Field Theory", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Statistical Field Theory", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Symmetries, Particles and Fields", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Advanced Quantum Field Theory", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "String Theory", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Supersymmetry", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "The Standard Model", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Applications of Quantum Field Theory", "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Particle Physics and Quantum Fields"},
    {"c": "Quantum Information Theory", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Quantum Information, Foundations and Gravity", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Quantum Entanglement in Many-body Physics", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Topological Quantum Matter", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Quantum Computation, Information and Foundations"},
    {"c": "Cosmology", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "General Relativity", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Black Holes", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Canonical Gravity", "T": "L", "h": 16, "u": 0, "e": false, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Field Theory in Cosmology", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Solitons, Instantons and Geometry", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Gauge-Gravity Duality", "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Gravitational Waves and Numerical Relativity", "T": "E", "h": 16, "u": 2, "e": true, "cat": "Theoretical Physics (DAMTP)", "subcat": "Relativity and Cosmology"},
    {"c": "Mathematical Analysis of the Incompressible Navier-Stokes Equations", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},
    {"c": "Distribution Theory and Applications", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},
    {"c": "Spectral Computations in Infinite Dimensions", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Applied and Computational Analysis"},
    {"c": "Astrophysical Fluid Dynamics", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Galaxy Formation", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Planetary System Dynamics", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Structure and Evolution of Stars", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Astrostatistics", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Dynamics of Astrophysical Discs", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Extrasolar Planets: Atmospheres and Interiors", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Further Stellar Evolution", "T": "L", "h": 16, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Radiative Processes in Astrophysics", "T": "L", "h": 16, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Astrophysics"},
    {"c": "Fluid Dynamics of Climate", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Non-Newtonian Flows", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Perturbation Methods", "T": "M", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Biological Flows", "T": "L", "h": 16, "u": 2, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Fluid Dynamics of Solid Earth", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Laboratory Demonstrations", "T": "L", "h": 8, "u": 0, "e": false, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Slow Viscous Flow", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Continuum Mechanics"},
    {"c": "Biological Physics", "T": "M", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Soft Matter and Biological Physics"},
    {"c": "Noisy Mechanics", "T": "L", "h": 24, "u": 3, "e": true, "cat": "Applied Mathematics (DAMTP)", "subcat": "Soft Matter and Biological Physics"}
];

function initOmeter() {
  decodeSelectionFromURL();
  change();
}

function updateShareLink() {
    let selectedIndices = [];
    for (let i = 0; i < courses.length; i++) {
        const cb = document.getElementById('cb' + i);
        if (cb && cb.checked) {
            selectedIndices.push(i);
        }
    }
    const code = selectedIndices.join(',');
    const essayState = document.getElementById('cbEssay').checked ? '1' : '0';
    
    const params = new URLSearchParams();
    if (code) {
        params.set('s', code);
    }
    if (essayState === '1') {
        params.set('e', essayState);
    }

    const paramString = params.toString();
    const hash = paramString ? '#' + paramString : '';
    const shareLink = document.getElementById('shareLink');
    const baseUrl = window.location.href.split('#')[0];
    
    shareLink.href = baseUrl + hash;
}

function decodeSelectionFromURL() {
    if (!window.location.hash || window.location.hash.length < 2) return;
    try {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const code = params.get('s');
        const essayState = params.get('e');

        if (essayState === '1') {
            const cbEssay = document.getElementById('cbEssay');
            if (cbEssay) cbEssay.checked = true;
        }

        if (code) {
            const selectedIndices = code.split(',');
            selectedIndices.forEach(indexStr => {
                const i = parseInt(indexStr, 10);
                if (!isNaN(i)) {
                    const cb = document.getElementById('cb' + i);
                    if (cb) cb.checked = true;
                }
            });
        }
    } catch (e) {
        console.error("Failed to decode URL hash:", e);
    }
}

function change() {
  let mUnits = 0, lUnits = 0, eUnits = 0;

  courses.forEach((course, i) => {
    const cb = document.getElementById('cb' + i);
    const row = document.getElementById('r' + i);
    if (!cb || !row) return;

    if (cb.checked) {
      if (course.T === 'M') mUnits += course.u;
      if (course.T === 'L') lUnits += course.u;
      if (course.T === 'E') eUnits += course.u;
      row.style.backgroundColor = '#ffffd0';
    } else {
      row.style.backgroundColor = '';
    }
  });

  const essayCb = document.getElementById('cbEssay');
  let essayUnits = 0;
  if (essayCb && essayCb.checked) {
    essayUnits = 3;
    lUnits += essayUnits;
  }

  const paperUnits = mUnits + lUnits + eUnits - essayUnits;
  const totalUnits = mUnits + lUnits + eUnits;

  document.getElementById('Mtotal').innerHTML = `Michaelmas Total: <strong>${mUnits}</strong> units`;
  document.getElementById('Ltotal').innerHTML = `Lent Total: <strong>${lUnits}</strong> units`;
  document.getElementById('Etotal').innerHTML = `Easter Total: <strong>${eUnits}</strong> units`;

  let warnings = [];
  if (paperUnits > 16) {
    warnings.push(`<span style="color:red; font-weight:bold;">Warning: Exceeds 16-unit limit for lecture courses.</span>`);
  }
  if (totalUnits > 19) {
    warnings.push(`<span style="color:red; font-weight:bold;">Warning: Exceeds 19-unit total limit.</span>`);
  }
  if (essayCb && essayCb.checked && totalUnits < 12) {
    warnings.push(`Note: Below 12 units recommended for a Pass with an essay.`);
  }

  document.getElementById('total0').innerHTML = `Total: <strong>${totalUnits}</strong> units. ${warnings.join(' ')}`;
  updateShareLink();
}

function resetAll() {
    // Navigates to the base URL, effectively clearing the hash and resetting the state
    window.location.href = window.location.href.split('#')[0];
}

function copyShareLink(event) {
    event.preventDefault(); // Prevent link from navigating
    const shareLink = document.getElementById('shareLink');
    const urlToCopy = shareLink.href;

    // Use a temporary textarea to copy the text for broader browser compatibility
    const textArea = document.createElement("textarea");
    textArea.value = urlToCopy;
    // Prevent the textarea from being visible
    textArea.style.position = 'fixed';
    textArea.style.top = 0;
    textArea.style.left = 0;
    textArea.style.width = '2em';
    textArea.style.height = '2em';
    textArea.style.padding = 0;
    textArea.style.border = 'none';
    textArea.style.outline = 'none';
    textArea.style.boxShadow = 'none';
    textArea.style.background = 'transparent';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        shareLink.textContent = 'URL Copied!';
        // Revert the text back after 2 seconds
        setTimeout(() => {
            shareLink.textContent = 'Share Selection';
        }, 2000);
    } catch (err) {
        console.error('Failed to copy text: ', err);
        shareLink.textContent = 'Copy Failed';
         setTimeout(() => {
            shareLink.textContent = 'Share Selection';
        }, 2000);
    }

    document.body.removeChild(textArea);
}

function expandAll() {
  const details = document.getElementsByTagName('details');
  for (let i = 0; i < details.length; i++) {
    details[i].open = true;
  }
}

function collapseAll() {
  const details = document.getElementsByTagName('details');
  for (let i = 0; i < details.length; i++) {
    details[i].open = false;
  }
}
</script>

<style type="text/css">
  body { font-family: sans-serif; }
  table { width: 100%; border-collapse: collapse; }
  td { border: solid black; border-width: 1px 3px 1px 3px; text-align: center; padding: 2px; }
  tr.none td { border-width: 3px 0px 3px 0px; }
  tr.box td { border: solid black; border-width: 3px 3px 3px 3px; }
  .term-container { border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 20px; }
  
  details { margin-bottom: 5px; }
  summary {
    font-size: 1em;
    cursor: pointer;
    padding: 4px;
    margin-top: 8px;
    list-style: none; /* Hide default triangle */
  }
  summary::-webkit-details-marker { display: none; }
  summary:before {
    content: '[+] ';
    font-family: monospace;
    font-size: 0.9em;
  }
  details[open] > summary:before {
    content: '[-] ';
  }
  
  /* Main Category styling */
  details.main-category > summary {
    font-weight: bold;
    /* font-size: 1.1em; <-- This was removed to make the font size consistent */
    background-color: #f2f2f2;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
  }
  details.main-category > details {
      margin-left: 20px;
  }
  
  /* Sub-category styling */
  details.sub-category > summary {
      font-weight: bold;
  }
  
  details.sub-category > table {
      margin-left: 15px;
      border: none;
  }
  details.sub-category > table td {
      border-width: 0 0 1px 0;
      border-style: dashed;
      border-color: #eee;
  }
</style>
</head>

<body>

<h1>Part III Course-O-Meter</h1>

<p>
  <table style="width: 60em;">
    <tr class="box">
      <td width="34%"><a id="shareLink" href="#" onclick="copyShareLink(event)">Share Selection</a></td>
      <td width="33%"><a href="javascript:expandAll();">Expand All</a> / <a href="javascript:collapseAll();">Collapse All</a></td>
      <td width="33%"><a href="javascript:resetAll();">Reset</a></td>
    </tr>
  </table>
</p>

<div style="width: 60em;">
    <script type="text/javascript">
    function generateTermHtml(term, termName) {
        let html = `<div class="term-container">`;
        html += `<div class='box' style='font-weight:bold; background-color:yellow;'><table><tr><td style='text-align:left;'>${termName}</td></tr></table></div>`;

        const termCourses = courses.map((c, i) => ({...c, id: i})).filter(c => c.T === term);
        const mainCats = [...new Set(termCourses.map(c => c.cat))].sort();

        mainCats.forEach(mainCat => {
            html += `<details class="main-category" open><summary>${mainCat}</summary>`; // Added 'open' to have them expanded by default
            const mainCatCourses = termCourses.filter(c => c.cat === mainCat);
            const subCats = [...new Set(mainCatCourses.map(c => c.subcat))].sort();

            subCats.forEach(subCat => {
                html += `<details class="sub-category" open><summary>${subCat}</summary><table>`; // Added 'open' to have them expanded by default
                html += '<col width="3%"><col width="77%"><col width="10%"><col width="10%">';
                html += "<tr style='font-weight:bold; font-size:90%;'><td></td><td style='text-align:left;'>Course</td><td>Hrs</td><td>Units</td></tr>";
                
                const subCatCourses = mainCatCourses.filter(c => c.subcat === subCat).sort((a,b) => a.c.localeCompare(b.c));
                subCatCourses.forEach(course => {
                    html += `<tr id="r${course.id}">`;
                    html += `<td><input type="checkbox" onchange="change();" id="cb${course.id}" ${!course.e ? 'disabled' : ''}></td>`;
                    html += `<td style="text-align:left">${course.c} ${!course.e ? '<span style="color:grey; font-size:90%;">(Non-examinable)</span>' : ''}</td>`;
                    html += `<td style="font-size:90%">${course.h}</td>`;
                    html += `<td style="font-size:90%">${course.u}</td>`;
                    html += `</tr>`;
                });
                html += '</table></details>';
            });
            html += '</details>';
        });

        html += `<div class="box"><table style="border-width:0;"><tr style="font-weight:bold; background-color:yellow;">`;
        html += `<td style="border:none; text-align:left;" id="${term}total">${termName} Total: <strong>0</strong> units</td>`;
        html += `</tr></table></div></div>`;
        return html;
    }
    
    document.write(generateTermHtml('M', 'Michaelmas'));
    document.write(generateTermHtml('L', 'Lent'));
    document.write(generateTermHtml('E', 'Easter'));
    </script>
</div>

<p>
<table style="width: 60em;">
  <tr class="box">
    <td width="3%"><input type="checkbox" onchange="change();" id="cbEssay"></td>
    <td style="text-align:left">Part III Essay</td>
    <td style="font-size:95%; width:20%;">3 units</td>
  </tr>
  <tr class="none"><td colspan="3">&nbsp;</td></tr>
  <tr class="box">
    <td colspan="3" id="total0" style="font-weight:bold;">Total: 0 units</td>
  </tr>
</table>
</p>

<hr>
<i>This tool is for guidance only, based on course information for the 2024-25 academic year.</i>

<script type="text/javascript">
  // This script is moved from the body onload event to the end of the body.
  // This ensures that all the HTML elements, including the dynamically generated
  // checkboxes, are present in the DOM before this script tries to access them.
  // This resolves the timing issue where the script would run before the elements existed.
  initOmeter();
</script>

</body>
</html>
